#!/bin/bash

set -e
SOURCE_FOLDER="./generated-deploy"
CONVERTED_FOLDER="./converted-deploy"
mkdir -p $CONVERTED_FOLDER
source_files=$(ls -al $SOURCE_FOLDER | grep "yml" | awk '{print $9}')
for source_file in ${source_files}; do
  filename=$(echo $source_file | cut -d'/' -f2)
  ## replace the first domain name 
  ## image: docker.io/a/b:v1 ==> image: infra-harbor.lab.pcfdemo.net/a/b:v1
  sed 's/ ["]*image["]*: [a-z0-9\-\."]*\// image: infra-harbor.lab.pcfdemo.net\/kubeflow\//g' $SOURCE_FOLDER/$filename > $CONVERTED_FOLDER/$filename
  echo "generated $CONVERTED_FOLDER/$filename"
done
echo "review unchanged"
set +x
echo "grep -r ' image: ' $CONVERTED_FOLDER | grep -v 'infra-harbor'"
grep -r " image: " $CONVERTED_FOLDER | grep -v "infra-harbor"
grep -r ' "image": ' $CONVERTED_FOLDER | grep -v "infra-harbor"
